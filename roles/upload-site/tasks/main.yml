---
# Ansible role for uploading the database and files to Enterprise.
# https://github.com/SU-SWS/ansible-playbooks
# ==================================================================
#
# This role uploads the database and files from local to Enterprise. It also
# runs a number of tasks to transform the database in such a way that images
# and absolute paths will work in the new ACSF environment. If any part of this
# role fails for a site, start from the top with a fresh download of the site.
#
# INPUTS:
#   ace_site_name
#   inventory_hostname
#   site_environment
#   drush_alias
#   drush_environment
#   stack
#
# OUTPUTS:
# --
#
# ALTERNATIVE ROLES:
# --
#
# REQUIREMENTS:
# --
#
# KNOWN ISSUES:
# --

- name: Drop database in ACE and install new database
  shell: "{{drush_alias }} {{ item }}"
  with_items:
    - "-y sql-drop"
    - "sqlc < /tmp/{{ inventory_hostname }}/dbdump.sql"
  notify: Clear site cache

# BEANS, FEEDS, and probably bears too!
# The change in where the entity class exists can cause fatal errors and not
# allow the rest to continue. This drush rr is to ensure that all the PHP
# classes are registered and in the right place before we try to run updates.
- name: Run drush rr before running anything else if we're having issues
  shell: "{{ drush_alias }} {{ item }}"
  with_items:
    - "-y rr"
  ignore_errors: "{% if ignore_updb_errors == 'TRUE' %}yes{% endif %}"

# We sometimes have order-of-operation issues on drush updb. For instance, a
# "Column not found: 1054 Unknown column 'base.status' in 'field list'" error.
# To get past that, we can set ignore_updb_errors="TRUE" in our inventory on a
# per-site basis. That will allow us to move past errors in this task, and run
# "drush updb" a second time in the following task.
- name: Update database schema with drush updb
  shell: "{{ drush_alias }} {{ item }}"
  with_items:
    - "-y updb"
  ignore_errors: "{% if ignore_updb_errors == 'TRUE' %}yes{% endif %}"

# This only runs "drush rr" if ignore_updb_errors == "TRUE"
- name: Run drush rr before running drush updb a second time for recalcitrant sites
  shell: "{{ drush_alias }} {{ item }}"
  with_items:
    - "-y rr"
  when: ignore_updb_errors == "TRUE"
  ignore_errors: yes

# This only runs "drush updb" if ignore_updb_errors == "TRUE"
- name: Run drush updb a second time for recalcitrant sites
  shell: "{{ drush_alias }} {{ item }}"
  with_items:
    - "-y updb"
  when: ignore_updb_errors == "TRUE"

# Rebuild the registry on all sites. Migrate files from s3fs to public.
- name: Migrate files from s3fs to public. Rebuild the registry after updating the database schema.
  shell: "{{ drush_alias }} {{ item }}"
  with_items:
#    - "-y vset s3fs_bucket {{ s3_migration_bucket }}"
    - "-y vset --exact s3fs_use_s3_for_private 0"
    - "-y vset --exact s3fs_use_s3_for_public 0"
    - "-y vset --exact s3fs_awssdk2_access_key {{ aws_access_key_id }}"
    - "-y vset --exact s3fs_awssdk2_secret_key {{ aws_secret_access_key }}"
#    - "-y s3fspublicize"
    - "-y rr"
  notify: Clear site cache
