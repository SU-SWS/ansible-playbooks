---
# Ansible role for identifying PHP in a database.
# https://github.com/SU-SWS/ansible-playbooks
# ===============================================
#
# The purpose of this role is to run a TASK, in this case, search for evidence
# of PHP in a database.  Upon finding what might be PHP, this role should
# abort migration of the host and save the PHP to our ansible.log file for
# review later.
#
# INPUTS:
#   inventory_hostname
#
# OUTPUTS:
#   database_php_candidates
#
# ALTERNATIVE ROLES:
# --
#
# REQUIREMENTS:
# --
#
# KNOWN ISSUES:
# --

- name: Check for PHP in database
  shell: "grep -o '.\\{0,20\\}{{ item }}.\\{0,20\\}' /tmp/{{ inventory_hostname }}/dbdump.sql; test $? -eq 1"
  register: database_php_candidates
  ignore_errors: yes
  with_items:
    - '$[^S$D|\.|0-9|conf|user|_SESSION][A-Za-z]'
    - '<?[^xml]'
    - 'eval('
    - 'preg_replace('
    - 'create_function'
    - 'include(\|include_once('
    - 'require(\|require_once('
    - 'exec('
    - 'passthru('
    - 'shell_exec('
    - 'system('
    - 'proc_open('
    - 'popen('
    - 'curl_exec('
    - 'curl_multi_exec('
    - 'parse_ini_file('
    - 'show_source('

- name: Save PHP in file
  copy:
    content: "{{ inventory_hostname }} {{ database_php_candidates | json_query('results[*].stdout_lines') }}"
    dest: "/tmp/ansible.log"
  register: php_logged
  when: database_php_candidates|failed
  failed_when: php_logged is defined
