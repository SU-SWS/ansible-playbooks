---
# Ansible role for creating a site on Site Factory.
# https://github.com/SU-SWS/ansible-playbooks
# =================================================
#
# The purpose of this role is to instantiate a STATE, in this case the
# existence of a site in Site Factory.
#
# INPUTS:
#   inventory_hostname
#   sitefactory_environment
#   profile
#   group_ids
#   stack_id
#   acquia_username
#   acquia_api_key
#
# OUTPUTS:
#   site_created
#
# ALTERNATIVE ROLES:
# --
#
# REQUIREMENTS:
# --
#
# KNOWN ISSUES:
# --
- name: Create new site on Site Factory
  uri:
    url: "https://www.{{ sitefactory_environment }}.acsitefactory.com/api/v1/sites"
    method: POST
    user: "{{ acquia_username }}"
    password: "{{ acquia_api_key }}"
    body:
      site_name: "{{ acsf_site_name }}"
      install_profile: "{{ profile }}"
      codebase: "{{ stack_id }}"
      group_ids: 126
    force_basic_auth: yes
    body_format: json
    return_content: yes
  register: site_created
  when: acsf_site_name not in existing_sites | json_query('json.sites[*].site')

- pause:
    minutes: 1

- name: Add vhost as domain
  uri:
    url: "https://www.{{ sitefactory_environment }}.acsitefactory.com/api/v1/domains/{{ item }}/add"
    method: POST
    user: "{{ acquia_username }}"
    password: "{{ acquia_api_key }}"
    force_basic_auth: yes
    body_format: json
    body:
      domain_name: "{{ vhost }}.stanford.edu"
  with_items: "{{ existing_sites | json_query(\"json.sites[?site=='\" + acsf_site_name + \"'].id\") }}"
  when:
    vhost is defined

# Waiting to find out via Acquia ticket #624799 if this is possible
# - name: Add inventory_hostname as domain
#   uri:
#     url: "https://www.{{ sitefactory_environment }}.acsitefactory.com/api/v1/domains/{{ item }}/add"
#     method: POST
#     user: "{{ acquia_username }}"
#     password: "{{ acquia_api_key }}"
#     force_basic_auth: yes
#     body_format: json
#     body:
#       domain_name: "{{ inventory_hostname }}.{{ sitefactory_environment }}.acsitefactory.com"
#     return_content: yes
#   register: inventory_hostname_domain_response
#   with_items: "{{ existing_sites | json_query(\"json.sites[?site=='\" + acsf_site_name + \"'].id\") }}"
